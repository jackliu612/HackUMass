<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.1.9/lib/p5.js"></script>
    <script src="hat.js"></script>
    <script src="faces.js"></script>
</head>
<body>
<div>
    <div class="inputoutput">
        <img id="imageSrc" alt="No Image"/>
        <div class="caption">imageSrc <input type="file" id="fileInput" name="file"/></div>
    </div>
    <div id="output" class="inputoutput">
        <canvas id="canvasOutput"></canvas>
        <div class="caption">canvasOutput</div>
    </div>
</div>
<script>
    //necessary for opencvJS on static webpages. Creates the classifiers without needing a webserver
    var Module = {
        wasmBinaryFile: 'https://huningxin.github.io/opencv.js/build/wasm/opencv_js.wasm',
        preRun: [function () {
            //Module.FS_createPreloadedFile('/', 'haarcascade_eye.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_eye.xml', true, false);
            Module.FS_createPreloadedFile('/', 'haarcascade_frontalface_default.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml', true, false);
            //Module.FS_createPreloadedFile('/', 'haarcascade_profileface.xml', 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_profileface.xml', true, false);
        }],
    };
</script>
<script type="text/javascript">


    //imageElement: uses a button to open file explorer to pick a picture
    let imgElement = document.getElementById('imageSrc');
    let inputElement = document.getElementById('fileInput');
    inputElement.addEventListener('change', (e) => {
        imgElement.src = URL.createObjectURL(e.target.files[0]);
    }, false);

    //the main meat of the face detection
    imgElement.onload = function () {
        let src = cv.imread(imgElement);
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
        let faces = new cv.RectVector();
        let faceCascade = new cv.CascadeClassifier();

        faceCascade.load('haarcascade_frontalface_default.xml');

        faceCoordinates = [];
// detect faces
        let msize = new cv.Size(0, 0);
        try {
            faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, msize, msize);
        } catch (err) {
            console.log(err);
        }

        for (let i = 0; i < faces.size(); ++i) {
            faceCoordinates.push([faces.get(i).x, faces.get(i).y, faces.get(i).x + faces.get(i).width, faces.get(i).y + faces.get(i).height]);
            // detect eyes in face ROI
        }
        // cv.imshow('canvasOutput', src);
        src.delete();
        gray.delete();
        faceCascade.delete();
        faces.delete();
        console.log(faceCoordinates);
        new p5(sketch, 'output');
    };
</script>
<script async src="https://docs.opencv.org/3.4.0/opencv.js" type="text/javascript"></script>
</body>
</html>